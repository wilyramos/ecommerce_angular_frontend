<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-neutral-800">Gestión de Categorías</h1>

  <button mat-flat-button color="primary" (click)="openCategoryDialog()">
    <mat-icon>add</mat-icon>
    <span>Nueva Categoría</span>
  </button>
</div>

@if (isLoading()) {
  <div class="text-center py-8">
    <p class="flex items-center justify-center text-lg text-neutral-600">
        <mat-icon class="animate-spin mr-2">refresh</mat-icon>
        Cargando categorías...
    </p>
  </div>
} @else {
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-neutral-200">
      <thead class="bg-neutral-200">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-neutral-700 uppercase tracking-wider">Nombre y Jerarquía</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-neutral-700 uppercase tracking-wider">Slug</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-neutral-700 uppercase tracking-wider">Atributos</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-neutral-700 uppercase tracking-wider">Acciones</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-neutral-200">
        @for (category of flatCategories(); track category._id) {
          <tr class="hover:bg-neutral-50 transition">
            <td class="px-6 py-3 text-sm text-neutral-900 font-medium">
              <span [style.padding-left.px]="category.level * 24" class="flex items-center">
                @if (category.level > 0) {
                  <!-- Usamos un SVG o un carácter estilizado para la jerarquía -->
                  <span class="text-neutral-400 mr-2 text-xl inline-block -translate-y-px">↳</span>
                }
                <!-- Hacemos el nombre clicable para facilitar la edición -->
                <strong class="cursor-pointer hover:text-neutral-600" (click)="openCategoryDialog(category)">
                    {{ category.name }}
                </strong>
              </span>
            </td>

            <td class="px-6 py-3 text-sm text-neutral-600 font-mono">
              {{ category.slug }}
            </td>

            <td class="px-6 py-3 text-sm text-neutral-500">
              @if (category.attributes?.length) {
                <span class="inline-flex items-center rounded-full bg-green-100 px-3 py-0.5 text-xs font-medium text-green-800">
                  <mat-icon class="!w-4 !h-4 text-xs mr-1">tune</mat-icon>
                  {{ category.attributes?.length }} Atributo(s)
                </span>
              } @else {
                <span class="text-neutral-400 italic text-xs">— Sin Atributos —</span>
              }
            </td>

            <td class="px-6 py-3 text-right text-sm whitespace-nowrap">
              <button
                mat-icon-button
                (click)="openCategoryDialog(category)"
                aria-label="Editar categoría"
                title="Editar"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteCategory(category)"
                aria-label="Eliminar categoría"
                title="Eliminar"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="4" class="px-6 py-8 text-center text-base text-neutral-500 bg-neutral-50">
              <p>No se encontraron categorías. ¡Presiona "Nueva Categoría" para comenzar!</p>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
}
