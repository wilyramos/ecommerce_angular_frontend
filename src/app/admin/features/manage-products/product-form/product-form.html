<h1
  mat-dialog-title
  class="text-2xl font-semibold text-gray-800 border-b border-gray-100 pb-4 flex items-center gap-2"
>
  <mat-icon class="text-primary-500">inventory</mat-icon>
  Nuevo producto
</h1>

<mat-dialog-content class="max-h-[75vh] overflow-y-auto px-2 sm:px-6">
  <form
    [formGroup]="form"
    class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 py-6"
  >
    <!-- DATOS GENERALES -->
    <mat-form-field class="col-span-2 w-full">
      <mat-label>Nombre del producto</mat-label>
      <input
        matInput
        formControlName="name"
        placeholder="Ej: Zapatillas Speed 2.0 Knit Negras"
      />
    </mat-form-field>

    <mat-form-field class="w-full">
      <mat-label>Categoría</mat-label>
      <mat-select formControlName="category">
        @for (cat of data.categories; track cat._id) {
        <mat-option [value]="cat._id">{{ cat.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field class="w-full">
      <mat-label>Marca</mat-label>
      <mat-select formControlName="brand">
        @for (brand of data.brands; track brand._id) {
        <mat-option [value]="brand._id">{{ brand.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field class="md:col-span-2 w-full">
      <mat-label>Descripción corta</mat-label>
      <textarea
        matInput
        rows="3"
        formControlName="shortDescription"
        placeholder="Ej: Zapatillas deportivas de punto elástico con suela ultraligera y logotipo bordado."
      ></textarea>
    </mat-form-field>

    <div class="md:col-span-2 flex items-center justify-between">
      <mat-slide-toggle formControlName="isActive" color="primary">
        Producto activo
      </mat-slide-toggle>
    </div>

    <!-- VARIANTES -->
    <div class="md:col-span-2 mt-10">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <mat-icon class="text-primary-500">inventory_2</mat-icon>
          Variantes del producto
        </h3>
      </div>

      <div formArrayName="variants" class="space-y-7">
        @for (variant of variants.controls; track $index; let i = $index) {
        <div
          [formGroupName]="i"
          class="rounded-xl border border-gray-200 bg-white p-6 shadow-sm hover:shadow-md transition-all duration-300"
        >
          <!-- CABECERA DE VARIANTE -->
          <div class="flex items-center justify-between mb-4">
            <h4 class="font-medium text-gray-700">
              Variante {{ i + 1 }}
            </h4>
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeVariant(i)"
              class="hover:bg-red-50"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <!-- CAMPOS PRINCIPALES -->
          <div class="grid grid-cols-12 gap-4">
            <mat-form-field class="col-span-12 sm:col-span-4">
              <mat-label>SKU</mat-label>
              <input matInput formControlName="sku" placeholder="Ej: BAL-SNK-001" />
            </mat-form-field>

            <mat-form-field class="col-span-6 sm:col-span-4">
              <mat-label>Precio</mat-label>
              <input
                matInput
                type="number"
                formControlName="price"
                placeholder="Ej: 3890.00"
              />
            </mat-form-field>

            <mat-form-field class="col-span-6 sm:col-span-4">
              <mat-label>Stock</mat-label>
              <input
                matInput
                type="number"
                formControlName="stock"
                placeholder="Ej: 10"
              />
            </mat-form-field>
          </div>

          <!-- ATRIBUTOS -->
          <div class="mt-6 pt-4 border-t border-gray-100">
            <h5 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <mat-icon class="text-primary-400">tune</mat-icon>
              Atributos de la variante
            </h5>

            <div formArrayName="attributes" class="space-y-2">
              @for (attr of getAttributesArray(i).controls; track $index; let
              j = $index) {
              <div [formGroupName]="j" class="grid grid-cols-12 gap-3">
                <mat-form-field class="col-span-5">
                  <mat-label>Clave</mat-label>
                  <input matInput formControlName="key" placeholder="Ej: Talla" />
                </mat-form-field>

                <mat-form-field class="col-span-5">
                  <mat-label>Valor</mat-label>
                  <input matInput formControlName="value" placeholder="Ej: 42 EU" />
                </mat-form-field>

                <div class="col-span-2 flex justify-end items-center">
                  <button
                    mat-icon-button
                    color="warn"
                    type="button"
                    (click)="removeAttribute(i, j)"
                    class="hover:bg-red-50"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              }
            </div>

            <button
              mat-stroked-button
              type="button"
              (click)="addAttribute(i)"
              class="w-full mt-3 border-dashed hover:bg-gray-50 text-gray-600"
            >
              <mat-icon>add</mat-icon> Añadir atributo (Color, Talla, Material...)
            </button>
          </div>

          <!-- IMÁGENES -->
          <div class="mt-6 pt-4 border-t border-gray-100">
            <h5 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
              <mat-icon class="text-primary-400">image</mat-icon>
              Imágenes de la variante
            </h5>

            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 mb-4">
              @for (imgUrl of getVariantImages(i).value; track $index; let
              imgIndex = $index) {
              <div
                class="relative group aspect-square rounded-lg overflow-hidden border border-gray-200 bg-gray-50"
              >
                <img
                  [src]="imgUrl"
                  alt="Previsualización"
                  class="w-full h-full object-cover"
                />
                <button
                  type="button"
                  (click)="removeImage(i, imgIndex, imgUrl)"
                  class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <mat-icon class="text-xs">close</mat-icon>
                </button>
              </div>
              }
              <button
                type="button"
                (click)="fileInput.click()"
                class="aspect-square border-2 border-dashed rounded-lg flex flex-col items-center justify-center text-gray-400 hover:text-primary-500 hover:bg-gray-50 transition-colors"
              >
                <mat-icon>add_a_photo</mat-icon>
                <span class="text-xs mt-1">Añadir</span>
              </button>
              <input
                hidden
                type="file"
                multiple
                #fileInput
                (change)="onFileSelected($event, i)"
                accept="image/png, image/jpeg, image/webp"
              />
            </div>
          </div>
        </div>
        }
      </div>

      <button
        mat-flat-button
        color="primary"
        type="button"
        (click)="addVariant()"
        class="w-full mt-8 font-medium shadow-sm hover:shadow-md"
      >
        <mat-icon>add</mat-icon> Añadir nueva variante
      </button>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions
  align="end"
  class="border-t border-gray-100 mt-4 pt-4 flex justify-end gap-3"
>
  <button
    mat-stroked-button
    color="warn"
    (click)="close()"
    class="hover:bg-red-50 hover:border-red-300"
  >
    Cancelar
  </button>
  <button
    mat-flat-button
    color="primary"
    (click)="onSave()"
    [disabled]="form.invalid"
    class="font-medium shadow-sm hover:shadow-md"
  >
    <mat-icon>save</mat-icon> Guardar
  </button>
</mat-dialog-actions>
