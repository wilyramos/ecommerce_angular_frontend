<!-- LOADING -->
@if (isLoading) {
  <div class="flex items-center justify-center min-h-[70vh]"></div>
}

<!-- ERROR -->
@if (errorMessage) {
  <div class="flex items-center justify-center min-h-[70vh] p-4 text-center text-red-500">
    {{ errorMessage }}
  </div>
}

<!-- PRODUCTO -->
@if (product && !isLoading) {
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <div class="grid md:grid-cols-[2fr_1fr] gap-10">

      <!-- IMÁGENES -->
      <div class="space-y-4">
        <!-- Carrusel solo en móvil -->
        <div class="relative overflow-hidden block md:hidden">
          <div
            class="flex transition-transform duration-500 ease-in-out"
            [style.transform]="'translateX(-' + currentIndex * 100 + '%)'"
          >
            @for (img of getDisplayedImages(); track $index) {
              <div
                class="min-w-full flex items-center justify-center overflow-hidden border-gray-100 bg-gray-50"
              >
                <img
                  [src]="img"
                  alt="Imagen de {{ product.name }}"
                  class="w-full h-auto max-h-[500px] object-contain"
                />
              </div>
            }
          </div>

          <!-- Controles -->
          <button
            (click)="prevImage()"
            class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/70 rounded-full p-3 shadow-sm hover:bg-white transition"
          >
            ‹
          </button>
          <button
            (click)="nextImage()"
            class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/70 rounded-full p-3 shadow-sm hover:bg-white transition"
          >
            ›
          </button>

          <!-- Indicadores -->
          <div class="absolute bottom-3 left-0 right-0 flex justify-center gap-2">
            @for (img of getDisplayedImages(); track i; let i = $index) {
              <div
                class="w-2.5 h-2.5 rounded-full"
                [class.bg-gray-900]="i === currentIndex"
                [class.bg-gray-300]="i !== currentIndex"
              ></div>
            }
          </div>
        </div>

        <!-- Grid 2 columnas en desktop -->
        <div class="hidden md:grid md:grid-cols-2 gap-4">
          @for (img of getDisplayedImages(); track $index) {
            <div
              class="flex items-center justify-center overflow-hidden"
            >
              <img
                [src]="img"
                alt="Imagen de {{ product.name }}"
                loading="lazy"
                class="w-full h-auto max-h-[600px] object-contain "
                (click)="selectImage(img)"
              />
            </div>
          }
        </div>
      </div>

      <!-- INFO PRODUCTO -->
      <div class="sticky top-24 self-start space-y-6">
        <div>
          <h2 class="text-sm uppercase tracking-wider text-gray-500 mb-1">
            {{ product.brand?.name }}
          </h2>
          <h1 class="text-xl  text-gray-900 mb-2">
            {{ product.name }}
          </h1>
          <p class="text-2xl font-light text-gray-900">
            <span class="text-md">s/</span>
            {{
              (selectedVariant ? selectedVariant.price : product.variants[0].price)
                | number: '1.2-2'
            }}
          </p>
        </div>

        <p class="text-gray-600 text-sm leading-relaxed whitespace-pre-line">
          {{ product.shortDescription }}
        </p>

        @if (uniqueColors.length > 0) {
          <div class="pt-2">
            <h3 class="text-sm text-gray-700 mb-2">
              Color:
              <span class="text-gray-500">{{ selectedColor || 'Selecciona' }}</span>
            </h3>
            <div class="flex gap-2 flex-wrap">
              @for (color of uniqueColors; track $index) {
                <button
                  (click)="selectColor(color)"
                  class="px-4 py-2 rounded-lg border text-sm transition-all duration-200"
                  [class.bg-black]="color === selectedColor"
                  [class.text-white]="color === selectedColor"
                  [class.border-gray-200]="color !== selectedColor"
                  [class.hover:border-gray-400]="color !== selectedColor"
                >
                  {{ color }}
                </button>
              }
            </div>
          </div>
        }

        <div class="pt-2">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-sm text-gray-700">Talla:</h3>
            <a href="#" class="text-sm text-gray-500 hover:text-gray-800 underline">Guía</a>
          </div>
          <div class="flex gap-2 flex-wrap">
            @for (talla of availableTallas; track $index) {
              <button
                (click)="selectTalla(talla)"
                class="h-10 w-16 rounded-lg border text-sm transition-all duration-200"
                [class.bg-black]="talla === selectedTalla"
                [class.text-white]="talla === selectedTalla"
                [class.border-gray-200]="talla !== selectedTalla"
                [class.hover:border-gray-400]="talla !== selectedTalla"
                [class.text-gray-400]="isOutOfStock(talla) && talla !== selectedTalla"
                [class.line-through]="isOutOfStock(talla)"
                [disabled]="isOutOfStock(talla)"
              >
                {{ talla }}
              </button>
            }
          </div>
        </div>

        <button
          (click)="addToCart()"
          [disabled]="!selectedVariant || selectedVariant.stock === 0"
          class="w-full bg-black text-white py-3 rounded-lg text-sm uppercase tracking-wider transition-colors hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed cursor-pointer"
        >
          Añadir al carrito
        </button>

        <div class="border-t border-gray-100 pt-4 text-xs text-gray-500 space-y-1">
          <p>Envíos gratis a todo el Perú</p>
          <p>Cambios y devoluciones fáciles</p>
          <p>Pagos 100% seguros</p>
        </div>
      </div>
    </div>
  </div>
}

@if (relatedProducts.length > 0) {
 <section class="mt-16">
    <h2 class="text-xl font-semibold mb-6 text-gray-900">
      También te puede interesar
    </h2>

    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
      @for (item of relatedProducts; track item._id) {
        <app-product-card [product]="item"></app-product-card>
      }
    </div>
  </section>
}
